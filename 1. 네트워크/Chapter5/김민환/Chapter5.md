# 5. 서버측의 LAN에는 무엇이 있는가?



### 방화벽의 원리와 동작

- 대부분의 서버 앞에 방화벽이 존재한다. 방화벽에서 서버 안의 특정 애플리케이션에 액세스하려는 패킷만 통과를 시키며 이를위해 **패킷 필터링형**으로 패킷을 선별한다.
- 패킷의 헤더 정보를 바탕으로 **필터링 조건을 설정한다.**
  - 송신측 IP 주소와 상관없이 수신측 IP주소가 웹 서버라면 통과시킨다.
  - 웹 서버에서 응답을 보내고 인터넷에서 응답을 보내는 곳과 패킷이 오는 송신측 IP 주소와 비교하여 같을 때 통과시킨다.
- 웹 서버 내의 특정 애플리케이션에만 접근할 수 있도록 **포트 번호를 사용한다.**
  - IP주소로만 패킷을 통과시키면 서버 내의 다른 애플리케이션에 접근하는 문제가 있을 수 있기 때문에 특정 애플리케이션에 접근할 수 있도록 포트번호도 비교한다.
- 웹 서버에서 인터넷에 액세스하는 동작도 차단시킬 수 있어야한다.
  - TCP 프로토콜은 양방향으로 패킷이 흐르기 때문에 패킷을 정지시킬 수 없다.
  - 따라서 패킷이 흐르는 방향이 아니라 액세스하는 방향을 기준으로 패킷을 정지시키도록 한다.
  - 이를위해 **TCP 헤더에 있는 컨트롤 비트를 사용한다.**
    - TCP는 최초 접속 단계에서 3개의 패킷이 흐른다.
    - 최초의 패킷만 SYN이 1, ACK가 0이 되고 다른 패킷은 이와다른 값을 갖는다.
    - 따라서 최초의 패킷과 두 번째 이후의 패킷을 구별할 수 있게된다.
    - 이를 통해 웹 서버가 인터넷에 액세스하는 것을 정지시킬 수 있다.
  - 하지만 접속 동작이 없는 UDP는 액세스 방향을 구별할 수 없고, 패킷을 전부 통과시키거나 차단해야한다. 
    - 패킷  필터링 방법 외에는 차단할 수 있는 방법이 존재한다.
- 인터넷에서 사내 LAN으로 액세스 할 수 없다.
  - 패킷 필터링형은 주소 변환의 기능도 가지고 있다. 
  - 시점과 종점으로 주소 변환이 필요한 경우 주소를 변환하는데 주소 변환을 이용하면 인터넷 측에서 사내 LAN에는 액세스할 수 없게된다. -> 인터넷에 있는 라우터에는 프라이빗 주소를 등록하지 않기 때문에
- 패킷 필터링형 방화벽은 IP 주소, 포트 번호, 컨트롤 비트 등으로 패킷을 통과시킬지 판단한다.
- 방화벽은 패킷의 시점과 종점만보고 판단하기 때문에 데이터에 위험이 되는 것이 포함될 수 있다.
  - 이를 대응하기위해 소프트웨어의 버그를 고쳐서 다운되지 않도록 하는 것과
  - 내용을 조사하여 위험한 데이터가 포함되어있는지 검사하는 별도의 소프트웨어를 준비하는 것이다.



### 복수 서버에 리퀘스트를 분배한 서버의 부하 분산

- 서버에 액세스가 증가할 때 복수의 서버를 통해 분산 처리를 한다.
  - 서버의 수만큼 분배하여 처리를 한다.
  - 이때 분배를 어떻게하는지 알아야하는데, DNS 서버에 같은 이름으로 여러 대의 웹 서버를 등록하여 차례대로 IP 주소를 되돌려주도록 한다.
  - 이렇게 여러대의 서버에 대한 IP 주소를 하나씩 차례대로 되돌려주는 것을 **라운드 로빈**이라고 한다.
  - 하지만 웹 서버가 고장났을 때 문제가 발생한다. DNS 서버는 웹 서버의 상태를 모르기 때문에 고장난 웹 서버의 IP 주소를 그대로 되돌려줄 것이다.
- 위와 같은 문제를 방지하기위해 **부하 분산 장치** 또는 **로드 밸런서**라는 기기가 고안되었다.
- 부하 분산 장치에 웹 서버와 같은 이름을 붙이고 부하 분산 장치의 IP 주소를 DNS에 등록한다.
  - 클라이언트는 이 장치가 웹 서버라고 여기고 리퀘스트 메시지를 보내야할지 판단한다.
- 복수 페이지에 걸쳐있지 않은 액세스는 웹 서버의 부하상태를 토대로 리퀘스트 메시지를 보낼지 판단한다.
  - 지속적으로 웹 서버의 상태를 수집하고, 시험 패킷을 보내 응답시간으로 부하를 판단한다.
- 복수 페이지에 걸쳐있을 때는 부하에 관계없이 이전의 리퀘스트와 같은 웹 서버에 전송해야 한다.
  - 복수 페이지에 걸쳐있다는 것을 판단하기 위해서는 HTTP 헤더 필드에 쿠키를 부가한다.



### 캐시 서버를 이용한 서버의 부하 분산

- 여러 대의 서버를 설치하는 것이아니라 역할에 따라 서버를 나눠서 분산처리하는 방법도 존재한다. 이 중 하나가 **캐시 서버**를 사용하는 것이다.
- 캐시 서버는 웹 서버에서 받아 보존해둔 데이터를 읽어서 클라이언트에 송신만하면 되기 때문에 웹 서버에서 보내는 것보다 속도가 빠르다.
  - 하지만 웹 서버의 데이터가 변경되면 캐시 서버의 데이터를 사용할 수 없다.
- **캐시 서버의 동작**
  - 캐시 서버는 데이터가 캐시에 저장되어있는 경우와 저장되어있지 않은 경우에 따라서 다르게 동작한다.
  - **데이터가 저장되어있지 않은 경우**
    - 어느 웹 서버에 리퀘스트 메시지를 보낼지 판단하고 헤더에 'Via'를 추가하여 보낸다.
    - 서버가 여러 대일 경우 URI를 보고 판단한다. 
    - 이제 캐시 서버가 클라이언트가 되어 웹 서버와 통신하고, 캐시 서버는 데이터를 받아 저장한 후에 클라이언트에 전송한다.
  - **데이터가 저장되어 있는 경우**
    - 캐시 서버는 웹 서버에 데이터가 변경되어있는지 조사하기위해 `If-Modified-Since`라는 헤더 필드를 추가하여 보낸다.
    - 웹 서버에서 최종 갱신 일자를 비교하여 변경되었는지 판단한다.
    - 변경사항이 있다면 데이터가 저장되어있지 않은 경우처럼 동작하며, 변경사항이 없다면 캐시에 저장된 데이터를 클라이언트에 전송한다.
- **포워드 프록시**
  - 클라이언트에 캐시 서버를 두는 것을 포워드 프록시라고 한다.
  - 프록시는 간접적으로 다른 네트워크 서비스에 접속할 수 있도록 해주는 것인데, 클라이언트가 이전에 액세스한 페이지의 경우 사내 LAN의 프록시에 액세스하는 것이 더 효율적이다.



### 콘텐츠 배포 서비스

- 서버에 캐시서버를 두는 경우

  - 웹 서버의 부하를 억제할 수 있다.
  - 인터넷의 트래픽을 억제할 수는 없다.
  - 캐시서버의 증설이 어렵다.

- 콘텐츠 배포 서비스

  - 캐시서버를 설치하고 이를 웹 서버 운영자에게 대출하는 서비스
  - 이 서비스를 제공하는 CDSP는 중요한 프로바이더와 계약하고 그곳에 다수의 캐시 서버를 설치한다.
  - 그리고 웹 서버와도 계약하여 캐시 서버를 연대시킨다.
  - 클라이언트가 웹 서버에 액세스할 때 CDSP의 캐시 서버에 액세스한다.
  - CDSP가 설치한 캐시 서버를 다수의 웹 서버가 공동으로 사용하면서 비용을 절감할 수 있다.

  
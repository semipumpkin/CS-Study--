# 03-03. 라우터의 패킷 중계 동작

> - `성공과 실패를 결정하는 1%의 네트워크 원리`를 참고하였다.



### 라우터의 개념

- 라우터는 패킷의 위치정보를 기반으로 다음 라우터까지의 최적의 경로를 통해 보내는 역할을 한다.
- **라우터의 내부 구조**로 동작 살펴보기
  - 포트를 통해 패킷을 수신하며 포트의 종류(ADSL, FTTH, 무선 LAN)에 맞는 규칙을 적용한다.
  - IP 패킷에 기록되어있는 수신처 IP 주소와 중계 대상을 등록한 표를 통해 중계 대상을 판단한다.
  - 중계 대상측의 포트로 패킷을 옮기고 송신 동작을 실행한다.



### 라우팅 테이블

- 라우팅 테이블은 라우터가 패킷을 중계할 때 어떤 경로로 어떻게 가야하는지 참고하는 표이다.
- 이를 통해 등록되어 있는 IP 주소와 수신처의 IP 주소를 비교한다.
  - 주소를 비교할 때 네트워크 번호의 비트 수를 판단해야하기 때문에 **넷마스크**도 포함되어 있다.
    - 넷마스크는 IP 주소에서 네트워크 주소와 호스트 주소를 알아내기위한 비트이다.
- 라우팅 테이블에는 **게이트웨이**와 **인터페이스**도 포함되어 있다.
  - 인터페이스는 패킷의 중계 대상이 갖고있는 입구가 어떠한 형식으로 되어있는지를 의미하고
  - 게이트웨이는 서로 다른 네트워크 간을 중계할 때 각 네트워크의 입구가된다. 
  - 즉, 패킷의 중계 대상이 어떠한 네트워크에 있고 해당 포트는 어떠한 형식으로 되어있는지 라우팅 테이블에 기술되어 있다.
- 라우팅 테이블의 **매트릭**은 목적지까지의 거리가 얼마나 되는지를 나타낸다.
- **라우팅 테이블을 등록하고 갱신**할 때는
  - 수동으로 경로 정보를 등록 및 개신하거나
  - 라우팅 프로토콜을 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체적으로 테이블에 등록한다. => 라우팅 프로토콜(`RIP`, `OSPF`, `BGP`)



### 라우터의 패킷 수신

- 라우터의 포트에는 MAC 주소가 할당되어 있어 자신의 주소에 해당하는 패킷만 수신하고 해당하지 않은 패킷은 폐기한다.
- 패킷 수신 동작이 끝나면 맨 앞에있는 MAC 헤더를 폐기한다.
  - MAC 헤더의 역할은 어떠한 라우터에게 패킷을 건네주는 것이기 때문에 패킷을 수신하여 역할이 끝났다.
- 이제 MAC 헤더 뒤에있는 IP 헤더를 보고 패킷 중계 동작에 들어간다.



### 중계 대상 찾기

- 중계 대상을 찾기위해 수신처 IP 주소와 라우팅 테이블의 수신처 항목을 조사하는 것이다.
  - 32bit를 전부 비교하는 것이 아닌 넷마스크를 통해 네트워크 번호만 비교한다.
- 네트워크 번호를 통해 중계 대상 후보를 찾는다.
  - 중계 대상 후보 중에 네트워크 번호의 비트 수가 가장 긴 것을 찾는다.
  - 네트워크 번호의 비트 수가 길다는 것은 호스트 번호의 비트 수가 짧아진다는 것이고
  - 호스트 번호로 할당 가능한 번호의 수가 적게 되며, 이는 서브넷이 작다는 것을 의미한다.
  - 서브넷이 작다는 것은 범위가 축소되었다는 뜻이다.
- 네트워크 번호의 길이가 같을 때는 **메트릭을 사용한다.**
- 만약 해당되는 정보와 일치하는 것이 없다면 패킷을 폐기하고 **ICMP 메시지로 송신처에 현재 상황을 통지한다.**
  - **ICMP**는 패킷을 운반할 때 발생하는 오류를 통지하거나 제어용 메시지를 보낼 때 이용하는 프로토콜이다.
- 라우팅 테이블에서 넷마크스가 `0. 0. 0. 0`인 행은 기본 경로를 나타낸다.
  - 이는 모든 주소에 대해 일치하다고 판단한다. => **중계 대상이 불분명**
  - 해당 행의 게이트웨이 항목에 인터넷으로 나가는 라우터를 등록하여 **다른 행에 해당하는 것이 없을 때** 패킷을 그곳으로 중계한다.



### 패킷의 유효기간

- 패킷은 유효기간이 있다.
- IP 헤더에는 **TTL (Time To Live)**가 존재하고 라우터를 경유할 때마다 해당 값을 1씩 줄인다.
  - 0이 되었을 때 패킷이 만료되었다는 것을 의미하고 폐기한다.
- 이는 패킷은 같은 장소를 반복적으로 순환하는 것을 막는다.
  - 라우팅 테이블이 완벽하지 않기 때문에 위와 같은 문제가 발생할 수 있다.



### 패킷의 조각 나누기

- 중계하는 패킷의 크기가 출력측의 패킷 최대 길이를 초과하면 패킷을 송신할 수 없다.
  - 회선 또는 LAN의 종류에 따라 패킷의 최대 길이가 달라진다.
- **조각 나누기**를 통해 패킷을 분할하고 길이를 짧게 만들어 중계한다.
  - 출력측의 **MTU**를 조사해야한다.
    - `MTU` : 한 개의 패킷으로 운반할 수 있는 데이터의 최대 길이
  - 패킷의 최대 길이는 포트의 종류에 따라 결정되기 때문에 헤더의 길이를 빼서 MTU를 계산하고 중계할 패킷의 길이와 비교한다.
  - TCP 헤더 이후의 부분을 차례대로 잘라낸다.
  - 분할한 패킷에 IP 헤더를 붙이고 패킷 중계를 진행한다.



### 패킷 송신하기

- 패킷의 맨 앞부분에 MAC 헤더를 부가하고 여기에 값을 설정하여 패킷을 완성시킨 후에 전기 신호로 변환하여 송신한다.
- 라우팅 테이블의 게이트웨이에서 패킷을 건네줄 상대를 판단하고 사앧의 IP 주소를 찾는다.
- IP 주소가 결정되었을 때 **ARP로 IP 주소에서 MAC 주소를 찾는다.**
  - ARP : 수신처 IP 주소에 대응하는 MAC 주소를 조사할 때 사용하는 프로토콜
- MAC 주소를 설정하고 송신 패킷이 만들어졌다면 전기 신호로 변환하여 포트에서 송신한다.
- 수신처 MAC 주소에 다음 라우터의 주소가 있기 때문에 스위칭 허브가 다음 라우터까지 패킷을 운반한다.
  - 라우터는 IP, 스위칭 허브는 이더넷의 개념에 기초하여 만들어졌다.
  - 여기서 IP가 이더넷에 전송을 의뢰하는 것은 최종 목적지까지 패킷을 운반하는 것이 아니라, 다음 라우터까지이다.
  - 최조 목적지까지 전달하는 동작은 IP가 담당하고 다음 라우터까지 패킷을 운반하는 동작은 이더넷이 담당한다.
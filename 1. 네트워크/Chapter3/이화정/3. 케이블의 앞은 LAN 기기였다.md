# Network 🌍

- *성공과 실패를 결정하는 1%의 네트워크 원리, Tsutomu Tone 저*

# Chapter 03 케이블의 앞은 LAN 기기였다

- 기본 용어
- `LAN (Local Area Network)` : 사용자가 포함된 **지역 네트워크**로 학교, 회사, 집 등 비교적 작은 단위에서 사용됨
- `이더넷(Ethernet)` : 네트워크에서 가장 많이 활용되는 기술 규격
- `허브` : 여러 대의 PC를 연결하기 위해 각각의 PC에서 나온 UTP케이블을 모아서 연결시켜주는 집진장치
    - `리피터 허브` : 컴퓨터와 컴퓨터를 연결시켜주는 일반적인 기능을 함, 연결된 컴퓨터가 많아질수록 컴퓨터 사이에서 교환되는 데이터들이 충돌하는 경우가 늘어나고 속도가 떨어짐
    - `스위칭 허브`: 더미 허브의 단점을 보완한 허브, 모든 데이터를 전달, 수신하지 않고 스위칭을 통해 목적지에만 전달함

[TOC]

![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled.png)

## 📌01 케이블과 리피터, 허브 속을 신호가 흘러간다

- 컴퓨터에서 전달한 신호가 케이블을 통해 허브, 라우터를 경유해 흘러가는 과정

### **1 개별 패킷의 독립적인 동작 형태**

- `패킷` : 정보 기술에서 패킷 방식의 컴퓨터 네트워크가 전달하는 데이터의 형식화된 블록, 헤더(제어 정보)와 내용(데이터)으로 이루어짐
- `PHY(MAU)` : Physical Layer Device, 현재의 100mb/s 이상의 이더넷을 지칭함

컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계장치에 의해 중계되어 목적지를 향함. 이 때 중계 장치는 데이터 부분을 보지 않고 패킷을 중계한다. 그렇기 때문에 패킷에 기록된 데이터, TCP 프로토콜의 제어정보 등의 상세 내용이 패킷을 운반하는 동작에 영향을 주지 않는다. 따라서 모든 패킷은 **서로 개별의 것으로 간주되어 목적지를 향한다**

### **2 LAN케이블의 핵심 : 신호를 약화시키지 않는 것**

LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 트위스트 페어 케이블로 이동한다. 그 후 신호는 케이블 속을 흘러 리피터 허브에 도달한다. 이 때 송출된 신호는 약화되고 뭉개진 상태로 허브에 도달한다. 케이블이 길수록 걸리는 시간이 길고 그에 따라 신호 에너지가 떨어지기 때문에 케이블이 길수록 신호가 약하다.

신호는 약화되고 잡음의 영향까지 더해지면 신호가 심각하게 변형되어 통신 오류를 야기할 수 있다. 그렇기 때문에 LAN케이블은 가능한 한 신호를 정확하게 전달해야 한다.

![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%201.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%201.png)

### **3 '꼼' : 잡음 방지**

- `트위스트 페어` : 두 가닥의 신호선을 한 조로 하여 마주 꼬았음
- `크로스토크` : 케이블 내부의 전류가 잡음을 발생시켜 다른 신호선에 대한 잡음이 되는 것

![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%202.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%202.png)

LAN 케이블에는 잡음의 영향을 억제하기 위한 대책으로 **트위스트 페어 케이블**이 마련되어 있다.

먼저, 잡음이 생기는 원리는 아래와 같다.

1. **외부의 전자파에 의한 잡음**
    1. 잡음의 원인 : 케이블의 주위에서 발생하는 전자파
    2. 전자파가 금속 등의 도전체에 닿으면 그 안에 전류 발생
    3. 케이블의 주위에 전자파가 있으면 다른 전류가 케이블 안에 침투
    4. 신호와 잡음의 전류가 뒤섞여서 신호의 파형이 변형된다.
2. **내부의 전자파에 의한 잡음**
    - 케이블 안에서 누설되는 전자파 ,신호선 안에 흐르는 전류로 인해 주위에 발생되는 전자파
    - 강한 잡음은 아니지만 한 개의 케이블 안에 여러 신호선이 위치해 거리가 가까운 것이 문제가 됨

- 외부의 전자파에 의한 잡음을 막기 위한 대책 : '꼼'

    선을 마주 꼬면 형태가 나선형이 되어 꼰 옆의 선에서 전류가 흐르는 방향이 반대로 바뀐다. 그 결과, 잡음에 의해 생긴 전류가 서로 상쇄되어 잡음에 의한 전류는 약화됨. 신호의 전류는 나선형으로 변함없이 흐르며, 잡음의 전류만 약화시킨다

- 내부의 전자파에 의한 잡음을 막기 위한 대책 : '꼼'

    내부의 전자파에 대한 대책도 꼼인데 위에서 설명된 것과는 조금 다른 원리이다. 꼬는 간격을 미묘하게 변화시켜서 어떤 부분에서는 플러스 신호가 가까이에 있고, 어떤  부분에서는 마이너스 신호가 가까이에 위치하게 한다. 그러면 플러스와 마이너스의 잡음의 영향이 반대가 되어 균형이 잡히면서 잡음의 영향을 약화한다.

### **4 리피터 허브 : 연결된 전체 케이블에 신호 송신**

신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어짐, 전체에 신호를 뿌리고 수신처 MAC 주소에 해당하는 기기만 패킷을 수신(이더넷의 기본원리)

리피터 허브 끝의 커넥터에는 **MDI/MDI-X**와 같이 쓰여있는 전환 스위치가 존재함

- MDI (Media Dependent Interface) : RJ-45 커넥터와 신호 송, 수신 회로를 직접 결선한 것
- MDI-X : 교차하여 결선하는 것

![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%203.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%203.png)

## **📌 02 스위칭 허브의 패킷 중계 동작**

---

- 스위칭 허브는 신호를 흘리지 않고 패킷의 신호를 수신하여 디지털 데이터의 형태로 되돌려주고, 다시 신호로 고쳐서 송신하는 동작을 통해 패킷을 운반한다
- MAC 주소표에서 MAC 주소를 조사하고 해당하는 포트에서 신호를 송신

### **1 스위칭 허브는 주소 테이블로 중계한다**

- 포트 : 커넥터와 안쪽에 있는 회로 부분을 지칭
- 스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어져 있음
- 중계 과정
    1. 흐르는 신호의 형식을 공통의 신호 형식으로 변환 (PHY 회로)
    2. 디지털 데이터로 변환, 패킷의 맨 끝에 FCS를 대조하여 오류 여부 검사, 오류가 없을 시 버퍼 메모리에 저장 (MAC 회로)
- 스위칭 허브의 포트에는 MAC 주소가 할당되어 있지 않아 모든 패킷을 수신하여 버퍼 메모리에 저장함

### **2 MAC 주소 테이블을 등록 및 갱신**

- 스위칭 허브는 패킷 중계 시 MAC 주소표의 내용을 갱신하는 동작을 실행, 자동 등록 및 삭제하므로 수동적인 관리가 불필요
    1. MAC 주소표에 등록
        - 송신처를 조사하여 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록한다
        - 수신할 때마다 등록 동작 실행하여 한번이라도 패킷을 송신하면 해당 기기의 MAC 주소가 MAC주소표에 등록됨
    2. MAC 주소표에 등록된 내용을 삭제
        - MAC 주소표에 등록된 정보가 사용되지 않고 일정 시간이 경과하면 삭제

### **3 예외적인 동작**

위에서 설명된 것이 스위칭 허브의 기본적인 동작이지만 예외적인 동작도 있다.

- 수신 포트와 송신 포트가 같을 경우 : 패킷을 중계하지 않고 폐기
- MAC 주소표에 수신처 MAC 주소와 일치하는 주소가 등록되어 있지 않은 경우 : 패킷을 수신한 포트 이외의 전체 포트에 패킷을 송신

### **4 전이중 모드 : 송신과 수신 동시 실행**

---

- **전이중 모드** : **송신과 수신을 동시에 실행할 수 있는 성질**로 리피터 허브에는 없는 스위칭 허브의 특징이다.

리피터 허브를 사용하는 경우 여러 대의 컴퓨터가 동시에 송신 동작을 개시하면 허브 내부에서 신호가 뒤섞여 신호가 파괴된다. (이더넷의 성질 - 충돌 현상) 스위칭 허브를 사용하면 이런 사태가 일어나지 않는다.

트위스트 페어 케이블의 신호선은 **송신용과 수신용이 구분되어 있어** 송/수신 신호가 충돌하지 않는다. 케이블이 연결된 대상 (스위칭 허브의 호트, LAN 어댑터의 회로, MAC 회로의 내부)도 송신과 수신이 구분되어 있어 충돌하지 않는다. 즉, 리피터 허브를 사용하면 충돌 현상이 발생하지 않는다.

### **5 자동 조정 : 최적의 전송 속도로 보냄**

---

- **`자동 조정 기능**(auto negotitation)` : 동작 모드와 상대의 전송 속도를 검출하여 자동으로 전환해주는 기능
    - 등장 배경 : 위에서 설명된 전이중 모드의 등장에 따라 전이중 모드와 반이중 모드(충돌 발생) 간의 전환할 필요가 생김. 수동 전환에 대한 불편함으로 자동 조정 기능이 등장
    - 작동 방식 : 링크 펄스 신호 방식을 활용, LAN어댑터 측과 허브 측의 전송속도, 동작 모드를 감안해서 양측에 최선인 방식으로 자동 설정

### **6 복수의 중계 동작 동시에 실행**

- 스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않으므로 빈 상태의 포트임. 비어 있는 상태의 포트에 별도의 패킷을 흘려 **동시에 여러 개의 패킷을 중계할 수 있다.**
- 단, 리피터 허브는 들어온 신호를 모든 포트에서 뿌리므로 동시에 두개 이상의 신호가 들어오면 패킷 충돌이 발생해 복수의 신호를 동시에 처리할 수 없다

## **📌03 라우터의 패킷 중계 동작**

---

- 라우터도 스위칭 허브와 마찬가지로 패킷을 중계하지만 동작에 차이가 있다.
- 스위칭 허브는 이더넷의 구조를 기초로 하여 설계되었지만 라우터는 IP의 개념을 기초로 하여 만들었기 때문

![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%204.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%204.png)

### **1 라우터의 기본**

라우터의 내부 구조를 간략화하면 **중계 부분**과 **포트 부분**으로 나눌 수 있다.

[라우터의 구조](https://www.notion.so/58883c83dfd24693a20171ad72ee3d1c)

- 패킷 중계 시의 과정 (위치 : 수행 내용)
    1. 포트 : 패킷 수신
    2. 중계 : 수신된 패킷의 IP 패킷에 기록되어있는 수신처 IP 주소와 중계 테이블을 대조 후 중계 대상을 판단
    3. 중계 대상측의 포트 : 패킷 송신
- **라우터의 주요 특징 : 각 포트에 MAC 주소와 IP 주소가 할당되어 있어 자신이 송신처이자 수신처가 된다**

### **2 경로표에 등록된 정보**

- **라우팅 테이블** : 경로표라고도 부르며, 라우터의 중계 측에서 가지고 있는 중계 대상에 관한 정보

[라우팅 테이블](https://www.notion.so/60ea24cde5a14840a7fda611b3454a2a)

- 경로표에 경로 정보를 등록하는 방법
    1. 사람이 수동으로 경로 정보를 등록 / 갱신
    2. 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표 등록
- **주소 집약** : 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록

### **3 라우터의 패킷 수신 동작**

- 라우터의 포트에는 MAC 주소가 할당되어 있으며, 라우터는 자신의 주소에 해당하는 패킷만 수신하고 해당하지 않는 패킷을 폐기함
- 수신 과정
    1. 흐르는 신호의 형식을 공통의 신호 형식으로 변환 (PHY 회로)
    2. 디지털 데이터로 변환, 패킷의 맨 끝에 FCS를 대조하여 오류 여부 검사, 정상이면 MAC헤더의 수신처 MAC 주소가 해당하는지 확인하여 패킷을 수신 버퍼 메모리에 저장, **해당하지 않을 경우 이더넷의 원칙에 따라 폐기** (MAC 회로)
    3. MAC 헤더 폐기 (라우터에 패킷을 건내주는 역할을 다했으므로)

### **4 경로표를 검색하여 출력 포트 발견**

- `ICMP 메시지` : 패킷을 운반할 때 발생하는 오류를 통지하거나 제어용 메시지를 보냄
- 중계 과정
    1. 중계 대상 조사 : `수신처` 항목을 조사하여 해당하는 행을 찾음
        1. 32비트 전부를 비교하는 것이 아닌 `넷마스크` 항목에 등록된 값에서 네트워크 번호의 비트 수를 판단하여 네트워크 번호 부분만 비교
        2. 복수의 후보 발견 시 네트워크 번호의 비트 수가 가장 긴 것을 찾는다. 네트워크 번호의 비트 수가 길면 호스트 번호의 비트 수가 짧다. 그것은 서브넷에 접속 가능한 대수가 적다는 의미이므로 그만큼 범위를 축소해서 정확성을 높일 수 있다.
        3. 네트워크 번호의 길이가 같은 것도 여러 개 존재하면 메트릭 값이 작은 쪽을 중계 대상으로 선택
    2. 해당하는 행이 없을 경우 : 패킷을 폐기하고 `ICMP 메시지`로 송신처에 이 사실을 통지

    ![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%205.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%205.png)

### **5 해당하는 경로가 없는 경우에 선택하는 기본 경로**

- 라우터의 경로표에서 넷마스크 항목이 0.0.0.0인 행은 기본 경로를 의미
- `기본 경로` : 이 행의 게이트웨이 항목에 인터넷으로 나가는 라우터를 등록하면 다른 행에서 주소를 찾지 못할 경우 그 곳으로 중계
- `기본 게이트웨이` : 기본 경로에 등록한 게이트웨이
- 넷마스크가 0.0.0.0이면 : 비교할 비트 수가 0이라는 의미, 즉 비교하지 않아도 된다는 의미로 모든 주소에 일치함

### **6 패킷의 유효기간**

- `TTL` : Time To Live, 패킷의 생존 기간, 송신처가 처음 패킷을 수신할 때 64 혹은 128로 설정하고 그 수만큼 라우터를 경유하면 패킷의 수명이 다한 것으로 간주, 폐기

### **7 패킷의 분할 : 조각 나누기 기능**

- `MTU` : 한 개의 패킷으로 운반할 수 있는 데이터의 최대 길이조각 나누기 (fragmentation) : 패킷을 분할하고 패킷의 길이를 짧게 만든 후 중계하는 IP프로토콜에 규정된 방식
- `PPPoE` : PPP over Ethernet, ADSL이나 FTTH라는 광대역 회선을 제어하는 방식 중 하나
1. 조각 나누기의 필요성
    - 출력 포트 측의 패킷의 최대 길이가 입력 측보다 작은 경우
    - 패킷의 크기가 출력 측의 패킷 최대 길이를 초과하면 패킷 송신이 불가
2. 조각 나누기의 과정
    1. 출력 측의 MTU를 조사하여 송신 가능 여부 확인
    2. IP 헤더의 플래그 필드를 조사하여 분할해도 좋을지 확인
        1. 분할할 수 없을 경우 : 패킷 폐기 후 ICMP 메시지로 송신처에 통지
    3. 출력 측의 MTU에 맞춰 헤더 이후의 부분 잘라냄
    4. IP 헤더를 덧붙임
        1. 이 때 IP헤더는 원래 패킷의 IP 헤더를 그대로 복사하지만 분할한 핵심정보를 기록하기 위해 일부 수정하기도 함

### **8 라우터의 송신 동작은 컴퓨터와 같다**

- `ARP` : 수신처 IP 주소에 대응하는 MAC 주소를 조사할 때 사용하는 프로토콜
- 송신 측은 출력 측의 포트에 따라 다름, 아래 과정은 포트가 이더넷인 경우의 동작
1. 경로표의 게이트웨이 항목에서 패킷을 건내줄 상대를 판단
    1. 게이트웨이 항목에 IP 주소가 있는 경우 : 이 주소가 건내줄 상대
    2. 게이트웨이 항목에 IP 주소가 없는 경우 : IP 헤더의 수신처 IP 주소가 건내줄 상대
2. ARP로 IP주소에서 MAC 주소를 조사하고 그 결과를 수신처 MAC 주소로 설정 
3. 송신처 MAC 주소 필드에 출력측의 포트에 할당한 MAC 주소 설정, 타입 필드에 0800 (16진수) 설정 → 송신 패킷 생성 완료
4. 송신 패킷을 전기 신호로 변환하여 포트에서 송신

### **9 라우터와 스위칭 허브의 관계**

- 결국 IP와 이더넷의 관계가 라우터와 스위칭 허브의 관계를 나타낸다. 라우터는 IP기반, 스위칭 허브는 이더넷 기반이기 때문이다.
- 통신 상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당하고 이 동작을 할 때 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)이 담당한다.

## 📌04 라우터의 부가 기능

### 1 주소 변환 으로 IP주소를 효율적으로 이용

- `주소 변환` : 패킷을 중계할 때 IP헤더에 기재된 IP 주소와 포트 번호를 바꿔쓰는 것
- `패킷 필터링` : 패킷을 중계할 때 MAC헤더, IP헤더, TCP헤더에 기록되어 있는 내용을 조사하여 그것이 사전에 설정한 조건에 합치되면 패킷을 중계하거나 폐기하는 동작을 실행, 부정 침입 방지
- `프라이비트 주소` : 특정한 규칙에 기초한 특정 주소를 사내용으로 사용
- `글로벌 주소` : 이전에 사용되던 고유한 주소 개념

![Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%206.png](Network%20a5a96f0e40dc435e8490be14c2647203/Untitled%206.png)

사내의 네트워크를 1) 인터넷에 공개하는 서버를 접속하는 부분과 2)사내용 네트워크 두 가지로 분할한다. 공개용 서버 쪽에는 글로벌 주소를 할당하고 인터넷과 직접 통신해야 한다. 사내 네트워크에는 프라이비트 주소를 할당하고 인터넷과는 직접 패킷을 주고받지 않도록 특별한 구조를 사용하여 접속하는데 이 구조가 `주소 변환`이다.

### 2 주소 변환의 기본 동작

1. 송신처의 IP 주소를 프라이비트 주소에서 글로벌 주소로 바꿔쓴다. 이 때 포트번호도 함께 바꿔서 기입한다.
2. 패킷을 인터넷에 송출
3. 회신 패킷이 라우터에 되돌아옴
4. 라우터에서 글로벌 주소와 포트 번호를 찾아서 이에 대응하는 프라이비트 주소와 포트 번호로 바꿔쓰고 사내 네트워크에 응답 패킷 보냄
5. 이후 패킷을 주고받을 시 대응표에 프라이비트 주소와 글로벌 주소의 대응 관계가 기록되어 있음
6. 데이터 송 수신이 끝나면 연결 끊기 동작의 패킷이 흐르다가 대응표에 등록된 내용 삭제